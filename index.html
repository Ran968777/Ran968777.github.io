<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Ran">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/06/12/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%90%8E%E7%9A%84%E6%9F%A5%E8%AF%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ran">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/12/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%90%8E%E7%9A%84%E6%9F%A5%E8%AF%A2/" class="post-title-link" itemprop="url">分库分表后的查询</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-06-12 14:16:31 / 修改时间：14:17:31" itemprop="dateCreated datePublished" datetime="2025-06-12T14:16:31+08:00">2025-06-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="分库分表后查询的问题"><a href="#分库分表后查询的问题" class="headerlink" title="分库分表后查询的问题"></a>分库分表后查询的问题</h1><p>分库分表后，查询需要跨库or跨表，怎么做呢</p>
<p>比如存在两个库db0, db1 ，两个库中都有order表，数据根据order_id 模2判定存在于哪个库</p>
<p>db0 中的数据: 2, 4 ,6 ,8</p>
<p>db1 中的数据: 1, 3, 5 ,7</p>
<p>假设现在需要查询。pageSize 为 2， pageNo 为2的数据，上帝视角来看，数据是1,2,3,4,5,6,7,8。 所以最后的结果应该是order_id为 3,4的数据。</p>
<h3 id="全局视野"><a href="#全局视野" class="headerlink" title="全局视野"></a>全局视野</h3><aside>
💡从不同的节点中获取数据，然后在内存中做处理
</aside>

<p>缺点： </p>
<ul>
<li>每个节点会返回更多的数据</li>
<li>随着页码的增大，性能会下降</li>
</ul>
<p>传统结构下，只需要这样查询即可达成要求</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `<span class="keyword">order</span>` <span class="keyword">order</span> <span class="keyword">by</span> order_id limit <span class="number">2</span> <span class="keyword">offset</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>在上面分库分表的场景下：这条 sql 会取到 db0 中的 6,8 和 db1 中的5,7 。这样的结果集及时经过处理也无法获得正确的结果，所以需要改写sql 为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `<span class="keyword">order</span>` <span class="keyword">order</span> <span class="keyword">by</span> order_id limit <span class="number">4</span> <span class="keyword">offset</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>分别获取 db0 , db1 中的前4条数据，然后再到内存中处理。</p>
<h2 id="后续页查询"><a href="#后续页查询" class="headerlink" title="后续页查询"></a>后续页查询</h2><aside>
💡用上一页的max_order_id 做为起点，取后续的n条记录。
</aside>

<p>缺点：不支持随机跳页</p>
<p>比如第一页的max_order_id是2。第二页的查询sql如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `<span class="keyword">order</span>` <span class="keyword">where</span> order_id <span class="operator">&gt;</span> <span class="number">2</span> <span class="keyword">order</span> <span class="keyword">by</span> order_id limit <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>在 db0 和 db1 中分别执行此sql 就会获取到 【4,6】 和【3,5】的数据。然后再到内存中做分页，也能获取到正确的结果</p>
<h3 id="二次查询"><a href="#二次查询" class="headerlink" title="二次查询"></a>二次查询</h3><p>步骤如下：</p>
<p>（1）SQL改写，将 order by time offset X limit Y; 改写成 order by time offset X&#x2F;N limit Y;</p>
<p>（2）多页返回，找到最小值time_min，分页记录的时间一定大于等于time_min（核心逻辑）；</p>
<p>（3）between二次查询 order by time between $time_min and $time_i_max;</p>
<p>（4）设置虚拟time_min，找到time_min在各个分库的offset，从而得到time_min在全局的offset；</p>
<p>（5）得到了time_min在全局的offset，自然得到了全局的 offset X limit Y；</p>
<aside>
💡这种方法的核心思想是，通过一个“粗略”的第一次查询，找到一个时间范围（或类似的排序字段范围），然后在这个范围内进行第二次“精确”的查询，以定位到真正需要的数据。

<p>因为分页的本质是跳过前 X 条记录，而 time_min 正是那个“第 X 条记录”的时间值，知道了它在排序中的位置，就能精准分页。</p>
<p>缺点：查询比较复杂，需要二次查询</p>
</aside>

<p>改写sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x为 <span class="number">2</span>，limit <span class="number">2</span> ,n 也是<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `<span class="keyword">order</span>` <span class="keyword">order</span> <span class="keyword">by</span> order_id limit <span class="number">2</span> <span class="keyword">offset</span> <span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在db0 查询到的结果是：【4,6】，在db1 查询到的结果是【3,5】</p>
<p>得到min_order_id 为3 。再执行一次between min_order_id and max_id后，结果与第一次一致。</p>
<p>此时估算order_id为3的数据在全局的offset为 1 (第一个语句中的offset 1) + 1 (第二个语句中的offst 也是1) &#x3D; 2。</p>
<p>所以order_id 的全局offset为2。在传统单表的情况下也需要offset 2 ,limit 2的数据。所以在【4,6】和【3,5】合并后再排序，从3开始取数，再取两个位置即可，最后的结果就是【3,4】。</p>
<p>第(4)步找到time_min的全局offset比较难，看了很久才理明白。</p>
<p>可以参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.healerjean.com/database/2019/09/11/1_%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E8%A7%A3%E9%87%8A%E4%BB%A5%E5%8F%8A%E9%97%AE%E9%A2%98%E5%87%BA%E7%8E%B0/#23%E5%88%86%E7%BB%84-%E6%9F%A5%E5%87%BA%E6%9D%A5%E5%86%8D%E8%AE%A1%E7%AE%97"><em>https://blog.healerjean.com/database/2019/09/11/1_分库分表解释以及问题出现&#x2F;#23分组-查出来再计算</em></a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7141194628472487972#heading-9"><em>https://juejin.cn/post/7141194628472487972#heading-9</em></a></p>
<p>一些理解，上述的方法感觉不是很方便。理解成本也很高。对于读多写少的系统来说。还是可以考虑使用类似es这类的中间件来做复杂的查询。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/06/12/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9A%84%E5%B0%8F%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ran">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/12/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9A%84%E5%B0%8F%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">分库分表的小实战</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-06-12 14:14:14 / 修改时间：14:16:12" itemprop="dateCreated datePublished" datetime="2025-06-12T14:14:14+08:00">2025-06-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h1><h2 id="✅-一、业务场景设定"><a href="#✅-一、业务场景设定" class="headerlink" title="✅ 一、业务场景设定"></a>✅ 一、业务场景设定</h2><p>假设你有一个电商订单系统，需要将订单数据进行分库分表。</p>
<ul>
<li>数据库：2 个（<code>order_db_0</code>, <code>order_db_1</code>）</li>
<li>表：每个库中 2 个分表（<code>t_order_0</code>, <code>t_order_1</code>）</li>
<li>路由规则：<code>user_id % 2</code> 决定库，<code>order_id % 2</code> 决定表（分库、分表的决策。这是一个可以扩展的点）</li>
</ul>
<h2 id="✅-二、技术选型"><a href="#✅-二、技术选型" class="headerlink" title="✅ 二、技术选型"></a>✅ 二、技术选型</h2><p><strong>数据库</strong>：MySQL 8</p>
<p><strong>ORM 框架</strong>：MyBatis-Plus 或原生 JDBC</p>
<p><strong>分片中间件</strong>：ShardingSphere-JDBC</p>
<h2 id="三、数据库启动"><a href="#三、数据库启动" class="headerlink" title="三、数据库启动"></a>三、数据库启动</h2><p>使用docker-compose启动两个数据库实例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql-db0:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0.32</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql-db0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">order_db_0</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;23306:3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./db0/init.sql:/docker-entrypoint-initdb.d/init.sql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db0-data:/var/lib/mysql</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mysql-db1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0.32</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql-db1</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">order_db_1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;23307:3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./db1/init.sql:/docker-entrypoint-initdb.d/init.sql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db1-data:/var/lib/mysql</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db0-data:</span></span><br><span class="line">  <span class="attr">db1-data:</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="核心的yaml配置"><a href="#核心的yaml配置" class="headerlink" title="核心的yaml配置"></a>核心的yaml配置</h2><p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">fen_ku_fen_biao</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.apache.shardingsphere.driver.ShardingSphereDriver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:shardingsphere:classpath:sharding-config.yaml</span></span><br><span class="line">    </span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>sharding-config.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="attr">ds_0:</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">dataSourceClassName:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line">    <span class="attr">jdbcUrl:</span> <span class="string">jdbc:mysql://localhost:23306/order_db_0?allowPublicKeyRetrieval=true&amp;serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">ds_1:</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">dataSourceClassName:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line">    <span class="attr">jdbcUrl:</span> <span class="string">jdbc:mysql://localhost:23307/order_db_1?allowPublicKeyRetrieval=true&amp;serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="type">!SHARDING</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="attr">t_order:</span></span><br><span class="line">        <span class="attr">actualDataNodes:</span> <span class="string">ds_$&#123;0..1&#125;.t_order_$&#123;0..1&#125;</span></span><br><span class="line">        <span class="attr">databaseStrategy:</span></span><br><span class="line">          <span class="attr">standard:</span></span><br><span class="line">            <span class="attr">shardingColumn:</span> <span class="string">user_id</span></span><br><span class="line">            <span class="attr">shardingAlgorithmName:</span> <span class="string">t_user_inline</span></span><br><span class="line">        <span class="attr">tableStrategy:</span></span><br><span class="line">          <span class="attr">standard:</span></span><br><span class="line">            <span class="attr">shardingColumn:</span> <span class="string">order_id</span></span><br><span class="line">            <span class="attr">shardingAlgorithmName:</span> <span class="string">t_order_inline</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">defaultDatabaseStrategy:</span></span><br><span class="line">      <span class="attr">standard:</span></span><br><span class="line">        <span class="attr">shardingColumn:</span> <span class="string">user_id</span></span><br><span class="line">        <span class="attr">shardingAlgorithmName:</span> <span class="string">default_database_inline</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">shardingAlgorithms:</span></span><br><span class="line">      <span class="attr">default_database_inline:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">INLINE</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="attr">algorithm-expression:</span> <span class="string">ds_1</span></span><br><span class="line">      <span class="attr">t_user_inline:</span></span><br><span class="line">        <span class="attr">type:</span>  <span class="string">INLINE</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="attr">algorithm-expression:</span> <span class="string">ds_$&#123;user_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br><span class="line">      <span class="attr">t_order_inline:</span></span><br><span class="line">        <span class="attr">type:</span>  <span class="string">INLINE</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="attr">algorithm-expression:</span> <span class="string">t_order_$&#123;order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">props:</span></span><br><span class="line">  <span class="attr">sql-show:</span> <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="代码仓库"><a href="#代码仓库" class="headerlink" title="代码仓库"></a>代码仓库</h3><p><a target="_blank" rel="noopener" href="https://github.com/Ran968777/fen_ku_fen_biao.git">https://github.com/Ran968777/fen_ku_fen_biao.git</a></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/06/11/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-%E5%88%86%E7%89%87%E9%94%AE%E4%B8%8E%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ran">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/11/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-%E5%88%86%E7%89%87%E9%94%AE%E4%B8%8E%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">分库分表-分片键与分片算法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-06-11 16:25:34 / 修改时间：16:28:12" itemprop="dateCreated datePublished" datetime="2025-06-11T16:25:34+08:00">2025-06-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="分片键与分片算法"><a href="#分片键与分片算法" class="headerlink" title="分片键与分片算法"></a>分片键与分片算法</h1><h2 id="分库分表的分片键的选择？"><a href="#分库分表的分片键的选择？" class="headerlink" title="分库分表的分片键的选择？"></a>分库分表的分片键的选择？</h2><ul>
<li>使用高频字段</li>
<li>可以让各分片数据均匀</li>
<li>尽量保证事务都在同一个分片内</li>
</ul>
<p>基因分片：</p>
<p>在一个电商场景中，使用订单id和买家id查询数据的话。可以采用将买家id部分提取到订单id中。这样就可以让用一个用户的订单都放在一个订单中</p>
<h2 id="分片算法"><a href="#分片算法" class="headerlink" title="分片算法"></a>分片算法</h2><aside>
💡根据分片键的值计算出数据应该存放在哪里
</aside>

<h3 id="哈希分片"><a href="#哈希分片" class="headerlink" title="哈希分片"></a>哈希分片</h3><p>比较简单的算法就是对计算分片键的余数。</p>
<p>优点：数据比较分散，不会存在某个分片有大量数据，比较均匀</p>
<p>缺点：分片扩容比较复杂，范围查询不方便</p>
<h3 id="范围分片（Range）"><a href="#范围分片（Range）" class="headerlink" title="范围分片（Range）"></a>范围分片（Range）</h3><p>可以根据时间的分片，个人觉得比较适用的场景有：在B端场景下，对内部的订单进行按时间分片。因为公司内部经常会按时间维度来考量业务的一些情况</p>
<p>优点：查询落在单个分片范围时，效率高。易扩容，也支持动态扩容</p>
<p>缺点：容易热点：若分片键值连续，新数据都会落入同一个分片，造成写热点；热门范围数据容易造成度热点</p>
<h3 id="配置表分片（config-dict）"><a href="#配置表分片（config-dict）" class="headerlink" title="配置表分片（config_dict）"></a>配置表分片（config_dict）</h3><aside>
💡直接定义分片和分片键值之间的映射关系，静态分片

</aside>

<p>比如为了满足不同国家对数据存储的要求，需要将数据按国家进行分片，由于国家字段值并不多的，我们可以做简单的映射：中国&#x3D;分片 1、美国&#x3D;分片2、其他&#x3D;分片3。</p>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><p><a target="_blank" rel="noopener" href="https://shuaifeihao.top/wiki/divide_database_table/index_01_2.html">https://shuaifeihao.top/wiki/divide_database_table&#x2F;index_01_2.html</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/609637884">https://zhuanlan.zhihu.com/p/609637884</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/28/readme/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ran">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/28/readme/" class="post-title-link" itemprop="url">5分钟搭建一个hexo博客</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-06-28 00:00:01 / 修改时间：00:03:16" itemprop="dateCreated datePublished" datetime="2023-06-28T00:00:01+08:00">2023-06-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="5-分钟搭建一个-hexo-博客"><a href="#5-分钟搭建一个-hexo-博客" class="headerlink" title="5 分钟搭建一个 hexo 博客"></a>5 分钟搭建一个 hexo 博客</h1><p>最后发现之前搭建的博客仓库文件丢失了，今天打算重新搭建一个，顺带记录一下，最快只需 5 分钟即可奥。</p>
<p>首先要确保已经安装了 hexo，接下来开始吧！</p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>新建一个 blog 文件夹，输入如下命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo init</span><br></pre></td></tr></table></figure>

<p>初始化完成以后，可以直接把博客跑起来看看效果（成就感满满）</p>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo s</span><br></pre></td></tr></table></figure>

<p>输入上面的命令，根据提示就能访问一个初始的博客仓库了，由于个人比较喜欢 next 主题的简单，所以接下来在安装 next 主题</p>
<h2 id="安装-next-主题"><a href="#安装-next-主题" class="headerlink" title="安装 next 主题"></a>安装 next 主题</h2><p>在站点目录下 clone next 主题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/theme-next/hexo-theme-next.git themes/next</span><br></pre></td></tr></table></figure>

<p>在_config.yml 中启用 next 主题即可，再用上面的 hexo s 就可以看到了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">theme: next</span><br></pre></td></tr></table></figure>

<h2 id="设置中文（友好的配置）"><a href="#设置中文（友好的配置）" class="headerlink" title="设置中文（友好的配置）"></a>设置中文（友好的配置）</h2><p>在_config.yml 配置即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">language: zh-CN</span><br></pre></td></tr></table></figure>

<h2 id="配置-git-仓库"><a href="#配置-git-仓库" class="headerlink" title="配置 git 仓库"></a>配置 git 仓库</h2><p>在我们写完博客之后，有时候想要发布到网上去，就可以使用 github pages 的方式。这里简单介绍下如何博客与 git 仓库建立联系</p>
<p>在博客的根目录安装 git 插件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>

<p>在_config.yml 中配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: your repository url</span><br><span class="line">  branch: master</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">因为我是用的ssh的方式，所以就不用配置别的啦，推荐用ssh的方式去push代码</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="部署-amp-发布-amp-分享"><a href="#部署-amp-发布-amp-分享" class="headerlink" title="部署&amp;发布&amp;分享"></a>部署&amp;发布&amp;分享</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo clean &amp;&amp; hexo deploy</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">搞定！</span></span><br></pre></td></tr></table></figure>

<p>如果你想要</p>
<h2 id="写文章"><a href="#写文章" class="headerlink" title="写文章"></a>写文章</h2><ul>
<li>创建一篇新的文章，输入命令后，在 source 下的_posts 文件继续完成大作就好了</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo n title</span><br></pre></td></tr></table></figure>

<ul>
<li><p>导入现有的 md 格式的文件</p>
<ol>
<li>在 md 文件的头部写入</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: your titel</span><br><span class="line">date: 2022-07-10 12:35:53</span><br><span class="line">tags: sql</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>放入 source&#x2F;_posts&#x2F;下即可啦</li>
</ol>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/27/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ran">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/27/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-27 15:26:32" itemprop="dateCreated datePublished" datetime="2023-06-27T15:26:32+08:00">2023-06-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/26/%E6%8E%A2%E7%B4%A2AQS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ran">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/26/%E6%8E%A2%E7%B4%A2AQS/" class="post-title-link" itemprop="url">探索AQS</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-06-26 22:38:10 / 修改时间：22:46:50" itemprop="dateCreated datePublished" datetime="2023-06-26T22:38:10+08:00">2023-06-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="AQS-1"><a href="#AQS-1" class="headerlink" title="AQS.1"></a>AQS.1</h1><p>生产者消费者模型</p>
<p>容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Box</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">maxSize</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生产者</span></span><br><span class="line"><span class="comment"> * 任务:让count+1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Box box;</span><br><span class="line"></span><br><span class="line">    Producer(Box box) &#123;</span><br><span class="line">        <span class="built_in">this</span>.box = box;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                produce();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (box) &#123;</span><br><span class="line">            <span class="keyword">while</span> (box.count &gt;= box.maxSize) &#123;</span><br><span class="line">                box.wait();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;生产线程名: &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;,生产前 count: &quot;</span> + box.count);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            box.count++;</span><br><span class="line">            System.out.println(<span class="string">&quot;生产线程名: &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;,生产完毕后 count: &quot;</span> + box.count);</span><br><span class="line">            <span class="comment">// 唤醒所有等待的线程（包括生产者和消费者）</span></span><br><span class="line">            box.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消费者</span></span><br><span class="line"><span class="comment"> * 任务:让count-1,如果count&lt;=0 则等待</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Box box;</span><br><span class="line"></span><br><span class="line">    Consumer(Box box) &#123;</span><br><span class="line">        <span class="built_in">this</span>.box = box;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                consumer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consumer</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (box) &#123;</span><br><span class="line">            <span class="keyword">while</span> (box.count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                box.wait();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;消费线程名: &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;,消费之前 count: &quot;</span> + box.count);</span><br><span class="line">            Thread.sleep(<span class="number">1500</span>);</span><br><span class="line">            box.count = box.count - <span class="number">1</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;消费线程名: &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;,消费完毕后 count: &quot;</span> + box.count);</span><br><span class="line">            box.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Box</span> <span class="variable">box</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Box</span>();</span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Consumer</span>(box);</span><br><span class="line">        consumer.start();</span><br><span class="line"></span><br><span class="line">        <span class="type">Producer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Producer</span>(box);</span><br><span class="line">        producer.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">执行结果</span><br><span class="line">生产线程名: Thread-<span class="number">1</span>,生产前 count: <span class="number">0</span></span><br><span class="line">生产线程名: Thread-<span class="number">1</span>,生产完毕后 count: <span class="number">1</span></span><br><span class="line">消费线程名: Thread-<span class="number">0</span>,消费之前 count: <span class="number">1</span></span><br><span class="line">消费线程名: Thread-<span class="number">0</span>,消费完毕后 count: <span class="number">0</span></span><br><span class="line">生产线程名: Thread-<span class="number">1</span>,生产前 count: <span class="number">0</span></span><br><span class="line">生产线程名: Thread-<span class="number">1</span>,生产完毕后 count: <span class="number">1</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>以上是生产者消费者模型的简单实现。代码不长，但又引出了新的问题。</p>
<ol>
<li>为什么 wait()和 notify()必须写在 synchronized 里呢？</li>
</ol>
<p>参考：*<strong>*Lost Wake-Up Problem(**</strong><a target="_blank" rel="noopener" href="https://www.cnblogs.com/myseries/p/13903051.html">https://www.cnblogs.com/myseries/p/13903051.html</a>*<strong>*)**</strong></p>
<ol>
<li>用 notifyAll()唤醒线程，但是无法唤醒指定的线程，这要怎么解决呢</li>
</ol>
<h2 id="LockSupport"><a href="#LockSupport" class="headerlink" title="LockSupport"></a>LockSupport</h2><p>LockSupport 用来创建锁和其他同步类的基本线程阻塞原语。简而言之，当调用 LockSupport.park 时，表示当前线程将会等待，直至获得许可，当调用 LockSupport.unpark 时，必须把等待获得许可的线程作为参数进行传递，好让此线程继续运行。同时 LockSupport 也是 AQS 框架的基础类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LockSupportTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 唤醒指定线程的demo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;t1即将阻塞&quot;</span>);</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            System.out.println(<span class="string">&quot;t1被唤醒&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;t2唤醒线程t1&quot;</span>);</span><br><span class="line">            LockSupport.unpark(t1);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;t3即将阻塞&quot;</span>);</span><br><span class="line">            LockSupport.park();</span><br><span class="line">        &#125;);</span><br><span class="line">        t3.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行结果</span></span><br><span class="line">t3即将阻塞</span><br><span class="line">t2唤醒线程t1</span><br><span class="line">t1即将阻塞</span><br><span class="line">t1被唤醒</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="**ReentrantLock**"></a>*<strong>*ReentrantLock**</strong></h2><p>可重入锁，用一句话来解释就是。一个已经拿到了锁的线程，可以再次拿到这个锁，而别的线程是拿不到的。</p>
<p>****ReentrantLock 的****内部结构</p>
<p><img src="/../img/%E6%9E%B6%E6%9E%84.png" alt="Untitled"></p>
<p>AQS 中有几个关键的属性 exclusiveOwnerThread，head，tail。他们分别是 exclusiveOwnerThread：当前独占锁的线程</p>
<p>head：AQS 底层双向链表的头节点</p>
<p>tail：AQS 底层双向链表的尾节点</p>
<p>假设一个场景：有一个线程已经获得了可重入锁，这时恰巧有另一个线程（名为 A）也想获取这个锁，那 AQS 是怎么做的呢？</p>
<h3 id="AQS-构造双向链表"><a href="#AQS-构造双向链表" class="headerlink" title="AQS 构造双向链表"></a>AQS 构造双向链表</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates and enqueues node for current thread and given mode.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mode Node.EXCLUSIVE for exclusive, Node.SHARED for shared</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the new node</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Inserts node into queue, initializing if necessary. See picture above.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> node the node to insert</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> node&#x27;s predecessor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>首先，当第一次进入到 addWaiter 时，AQS 的 tail 节点为空，所以会进入到 enq 中。</li>
<li>在 enq 中，先判断 tail 是否为空，如果为空，那么就要先初始化 AQS 的队列，也就是会先初始化出一个空的头结点。（双向链表带一个空的头指针有很多好处，之一就是可以避免空指针）</li>
<li>最后把入参 node(当前待获得锁的线程所封装的 node)用尾插法，插入到这个双向队列即可。</li>
</ol>
<p><img src="/../img/AQS.png" alt="Untitled"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/22/mybatis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ran">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/22/mybatis/" class="post-title-link" itemprop="url">mybatis的源码小记（1）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-01-22 21:54:53 / 修改时间：21:54:34" itemprop="dateCreated datePublished" datetime="2023-01-22T21:54:53+08:00">2023-01-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mybatis的源码小记（1）"><a href="#mybatis的源码小记（1）" class="headerlink" title="mybatis的源码小记（1）"></a>mybatis的源码小记（1）</h1><h2 id="对象简介"><a href="#对象简介" class="headerlink" title="对象简介"></a>对象简介</h2><blockquote>
<p>configuration：一个庞大的全局配置</p>
</blockquote>
<blockquote>
<p>SqlSession：了在数据库执行 SQL 命令所需的所有方法.</p>
</blockquote>
<blockquote>
<p>SqlSessionFactory：构造SqlSession的工厂</p>
</blockquote>
<blockquote>
<p>MapperRegistry：getMapper是从configuration下的mapperRegistry获取的。</p>
</blockquote>
<h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h2><ul>
<li>从mybatis获取mapper开始</li>
</ul>
<p>原始的使用mybatis的方式是首先构建一个SqlSession，接着从SqlSession中获取mapper。最后执行mapper中的方法即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_SqlSessionFactory</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 1. 从SqlSessionFactory中获取SqlSession</span></span><br><span class="line">    <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(Resources.getResourceAsReader(<span class="string">&quot;mybatis-config-datasource.xml&quot;</span>));</span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 获取映射器对象</span></span><br><span class="line">    <span class="type">UserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> sqlSession.getMapper(UserDao.class);</span><br><span class="line"></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.queryUserInfoById(<span class="number">1L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么从SqlSession中获取的mapper到底是什么呢，接下来就来一探究竟。</p>
<p>进入DefaultSqlSession（SqlSession的默认实现）的getMapper方法，可以发现最终是进入的configuration下的mapperRegistry.getMapper()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapperRegistry</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Configuration config;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MapperRegistry</span><span class="params">(Configuration config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> &#123;</span><br><span class="line">        MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory)<span class="built_in">this</span>.knownMappers.get(type);</span><br><span class="line">        <span class="keyword">if</span> (mapperProxyFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Type &quot;</span> + type + <span class="string">&quot; is not known to the MapperRegistry.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Error getting mapper instance. Cause: &quot;</span> + var5, var5);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mapperRegistry中有一个变量叫knownMappers，这里是以mapper的class对象为key，以生成mapper对象（也就是MapperProxy）的工厂为value的一个HashMap。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>一句话总结mybatis获取mapper的过程就是：根据class对象，从mapperRegistry中获取mapper的代理对象，且是每次获取都会创建新的代理对象，这也印证了官网所说mapper的作用域是在方法级别的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/22/mybatis.2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ran">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/22/mybatis.2/" class="post-title-link" itemprop="url">mybatis的源码小记（2）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-22 21:54:53" itemprop="dateCreated datePublished" datetime="2023-01-22T21:54:53+08:00">2023-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-06 14:03:23" itemprop="dateModified" datetime="2023-02-06T14:03:23+08:00">2023-02-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mybatis的源码小记（2）"><a href="#mybatis的源码小记（2）" class="headerlink" title="mybatis的源码小记（2）"></a>mybatis的源码小记（2）</h1><h2 id="mapper-xxx"><a href="#mapper-xxx" class="headerlink" title="mapper.xxx()"></a>mapper.xxx()</h2><p>首先还是从这段简单的使用场景说起，上一篇文章简单描述了下sqlSession.getMapper()的具体实现，那么获取mapper之后的查询逻辑又是怎么样的呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_SqlSessionFactory</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 1. 从SqlSessionFactory中获取SqlSession</span></span><br><span class="line">    <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(Resources.getResourceAsReader(<span class="string">&quot;mybatis-config-datasource.xml&quot;</span>));</span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 获取映射器对象</span></span><br><span class="line">    <span class="type">UserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> sqlSession.getMapper(UserDao.class);</span><br><span class="line"></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.queryUserInfoById(<span class="number">1L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>众所周知，接口是没有方法体的。所以直接来到MapperProxy#invoke</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">      <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.isDefaultMethod(method)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.invokeDefaultMethod(proxy, method, args);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">    <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(var5);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">MapperMethod</span> <span class="variable">mapperMethod</span> <span class="operator">=</span> <span class="built_in">this</span>.cachedMapperMethod(method);</span><br><span class="line">  <span class="comment">// 交给封装的mapperMethod去执行</span></span><br><span class="line">  <span class="keyword">return</span> mapperMethod.execute(<span class="built_in">this</span>.sqlSession, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MapperMethod根据SqlCommand根据去分发具体的执行，其实最后还是把方法转交给了sqlSession去处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(SqlSession sqlSession, Object[] args)</span> &#123;</span><br><span class="line">  Object param;</span><br><span class="line">  Object result;</span><br><span class="line">  <span class="keyword">switch</span>(<span class="built_in">this</span>.command.getType()) &#123;</span><br><span class="line">    <span class="keyword">case</span> INSERT:</span><br><span class="line">      param = <span class="built_in">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = <span class="built_in">this</span>.rowCountResult(sqlSession.insert(<span class="built_in">this</span>.command.getName(), param));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> UPDATE:</span><br><span class="line">      param = <span class="built_in">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = <span class="built_in">this</span>.rowCountResult(sqlSession.update(<span class="built_in">this</span>.command.getName(), param));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DELETE:</span><br><span class="line">      param = <span class="built_in">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = <span class="built_in">this</span>.rowCountResult(sqlSession.delete(<span class="built_in">this</span>.command.getName(), param));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SELECT:</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.method.returnsVoid() &amp;&amp; <span class="built_in">this</span>.method.hasResultHandler()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.executeWithResultHandler(sqlSession, args);</span><br><span class="line">        result = <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.method.returnsMany()) &#123;</span><br><span class="line">        result = <span class="built_in">this</span>.executeForMany(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.method.returnsMap()) &#123;</span><br><span class="line">        result = <span class="built_in">this</span>.executeForMap(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.method.returnsCursor()) &#123;</span><br><span class="line">        result = <span class="built_in">this</span>.executeForCursor(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        param = <span class="built_in">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        <span class="comment">// 在这里交给sqlSession</span></span><br><span class="line">        result = sqlSession.selectOne(<span class="built_in">this</span>.command.getName(), param);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FLUSH:</span><br><span class="line">      result = sqlSession.flushStatements();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Unknown execution method for: &quot;</span> + <span class="built_in">this</span>.command.getName());</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>SqlSession把与数据库的处理逻辑都交给了Executor，这样做的好处是解耦，避免SqlSession中太多逻辑，从而导致类本身非常复杂，不易于拓展。</p>
<p>为了阅读的流程，所以这里只提及Executor中的一种实现：SimpleExecutor，并且先隐藏一级缓存和二级缓存的部分逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">selectList</span><span class="params">(String statement, Object parameter, RowBounds rowBounds)</span> &#123;</span><br><span class="line">  List var5;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">MappedStatement</span> <span class="variable">ms</span> <span class="operator">=</span> <span class="built_in">this</span>.configuration.getMappedStatement(statement);</span><br><span class="line">    <span class="comment">// 转交给executor去处理，默认实现是SimpleExecutor</span></span><br><span class="line">    var5 = <span class="built_in">this</span>.executor.query(ms, <span class="built_in">this</span>.wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception var9) &#123;</span><br><span class="line">    <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error querying database.  Cause: &quot;</span> + var9, var9);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ErrorContext.instance().reset();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一般我们使用JDBC查询语句步骤就是1.获取链接，2.设置sql，3.设置参数，4.查询，5.封装结果集，所以其实Executor也就是帮助我们完成了这些步骤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">  <span class="comment">//获取boundSql</span></span><br><span class="line">    <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> ms.getBoundSql(parameter);</span><br><span class="line">    <span class="type">CacheKey</span> <span class="variable">key</span> <span class="operator">=</span> <span class="built_in">this</span>.createCacheKey(ms, parameter, rowBounds, boundSql);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.query(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">doQuery</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    List var9;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//获取链接</span></span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> ms.getConfiguration();</span><br><span class="line">      <span class="comment">//创建一个语句处理器</span></span><br><span class="line">        <span class="type">StatementHandler</span> <span class="variable">handler</span> <span class="operator">=</span> configuration.newStatementHandler(<span class="built_in">this</span>.wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      <span class="comment">// 准备语句，设置参数</span></span><br><span class="line">        stmt = <span class="built_in">this</span>.prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">        var9 = handler.query(stmt, resultHandler);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.closeStatement(stmt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var9;</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>

<h2 id="处理流程解析"><a href="#处理流程解析" class="headerlink" title="处理流程解析"></a>处理流程解析</h2><p>​	<img src="/../../../../../Downloads/statement.png" alt="statement"></p>
<h3 id="创建StatementHandler"><a href="#创建StatementHandler" class="headerlink" title="创建StatementHandler"></a>创建StatementHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//创建语句处理器</span></span><br><span class="line"><span class="keyword">public</span> StatementHandler <span class="title function_">newStatementHandler</span><span class="params">(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;</span><br><span class="line">    <span class="comment">//创建路由选择语句处理器</span></span><br><span class="line">    <span class="type">StatementHandler</span> <span class="variable">statementHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RoutingStatementHandler</span>(executor, mappedStatement, parameterObject, rowBounds, resultHandler, boundSql);</span><br><span class="line">    <span class="comment">//插件在这里插入</span></span><br><span class="line">    statementHandler = (StatementHandler) interceptorChain.pluginAll(statementHandler);</span><br><span class="line">    <span class="keyword">return</span> statementHandler;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这里创建RoutingStatementHandler，本质上是根据statementType创建不同类型的代理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">RoutingStatementHandler</span><span class="params">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;</span><br><span class="line">  <span class="comment">//根据语句类型，委派到不同的语句处理器(STATEMENT|PREPARED|CALLABLE)</span></span><br><span class="line">  <span class="keyword">switch</span> (ms.getStatementType()) &#123;</span><br><span class="line">    <span class="keyword">case</span> STATEMENT:</span><br><span class="line">      delegate = <span class="keyword">new</span> <span class="title class_">SimpleStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PREPARED:</span><br><span class="line">      delegate = <span class="keyword">new</span> <span class="title class_">PreparedStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CALLABLE:</span><br><span class="line">      delegate = <span class="keyword">new</span> <span class="title class_">CallableStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutorException</span>(<span class="string">&quot;Unknown statement type: &quot;</span> + ms.getStatementType());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="StatementHandler的继承关系"><a href="#StatementHandler的继承关系" class="headerlink" title="StatementHandler的继承关系"></a>StatementHandler的继承关系</h3><p>![image-20230130220842307](..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230130220842307.png)</p>
<p>其中三种具体实现分别对应</p>
<blockquote>
<p>SimpleStatementHandler 简单语句处理器(STATEMENT)</p>
<p>PreparedStatementHandler 预处理语句处理器(PREPARED)</p>
<p>CallableStatementHandler 存储过程语句处理器(CALLABLE)</p>
</blockquote>
<p>接下来是调用resultHandler处理返回的结果集</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PreparedStatementHandler</span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="title function_">query</span><span class="params">(Statement statement, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> (PreparedStatement)statement;</span><br><span class="line">        ps.execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.resultSetHandler.handleResultSets(ps);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>一句话总结mapper的执行流程就是，mapper的代理会去通过sqlSession找到executor来执行对应的sql，然后在通过resultHandler来封装返回的结果集。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/19/Java%E5%80%BC%E4%BC%A0%E9%80%92%E8%BF%98%E6%98%AF%E5%BC%95%E7%94%A8%E4%BC%A0%E9%80%92%E7%9A%84%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ran">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/19/Java%E5%80%BC%E4%BC%A0%E9%80%92%E8%BF%98%E6%98%AF%E5%BC%95%E7%94%A8%E4%BC%A0%E9%80%92%E7%9A%84%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">Java值传递还是引用传递的实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-08-19 22:07:00 / 修改时间：22:07:41" itemprop="dateCreated datePublished" datetime="2022-08-19T22:07:00+08:00">2022-08-19</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Java值传递还是引用传递的实践"><a href="#Java值传递还是引用传递的实践" class="headerlink" title="Java值传递还是引用传递的实践"></a>Java值传递还是引用传递的实践</h1><p>首先看下值传递和引用传递的定义</p>
<blockquote>
<ul>
<li><strong>Pass by Value</strong>: The method parameter values are copied to another variable and then the copied object is passed, that’s why it’s called pass by value.</li>
<li>值传递（pass by value）是指在调用函数时将实际参数复制一份传递到函数中，这样在函数中如果对参数进行修改，将不会影响到实际参数。</li>
<li><strong>Pass by Reference</strong>: An alias or reference to the actual parameter is passed to the method, that’s why it’s called pass by reference.</li>
<li>引用传递（pass by reference）是指在调用函数时将实际参数的地址直接传递到函数中，那么在函数中对参数所进行的修改，将影响到实际参数。</li>
</ul>
</blockquote>
<h2 id="实践代码"><a href="#实践代码" class="headerlink" title="实践代码"></a>实践代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.junit.Test</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_update</span><span class="params">()</span>&#123;</span><br><span class="line">      <span class="type">int</span> i= <span class="number">0</span>;</span><br><span class="line">      update_i(i);</span><br><span class="line">      System.out.println(i);</span><br><span class="line">  		<span class="comment">// 打印 1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">update_i</span><span class="params">(<span class="type">int</span> i)</span>&#123;</span><br><span class="line">      i = <span class="number">100</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@org</span>.junit.Test</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_update_string</span><span class="params">()</span>&#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">      update_str(str);</span><br><span class="line">      System.out.println(str);</span><br><span class="line">     	<span class="comment">// 打印 hello world</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">update_str</span><span class="params">(String str)</span> &#123;</span><br><span class="line">      str = <span class="string">&quot;bye world&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@org</span>.junit.Test</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_update_string_builder</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;hello world &quot;</span>);</span><br><span class="line">      update_sb(sb);</span><br><span class="line">      System.out.println(sb);</span><br><span class="line">    	<span class="comment">// 打印 hello world 123</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">update_sb</span><span class="params">(StringBuilder sb)</span> &#123;</span><br><span class="line">      sb.append(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h2 id="在内存中的解释"><a href="#在内存中的解释" class="headerlink" title="在内存中的解释"></a>在内存中的解释</h2><p>通过上面的例子再结合定义其实已经可以得出结论，java就是值传递的。下面在附上简单的图示，帮助理解。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ran968777/images/imgs/image-20220818220817076.png" alt="image-20220818220817076"></p>
<h2 id="简单的总结"><a href="#简单的总结" class="headerlink" title="简单的总结"></a>简单的总结</h2><p>java中方法参数传递方式是按值传递。</p>
<p>如果参数是基本类型，传递的是基本类型的字面量值的拷贝。</p>
<p>如果参数是引用类型，传递的是该参量所引用的对象在堆中地址值的拷贝。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/31203609/answer/103467065">https://www.zhihu.com/question/31203609/answer/103467065</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/31203609/answer/576030121">https://www.zhihu.com/question/31203609/answer/576030121</a></p>
<p><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/java-is-pass-by-value-and-not-pass-by-reference">https://www.digitalocean.com/community/tutorials/java-is-pass-by-value-and-not-pass-by-reference</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/10/%E6%B5%85%E5%B0%9Din%E5%92%8Cor%E7%9A%84%E6%95%88%E7%8E%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ran">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/10/%E6%B5%85%E5%B0%9Din%E5%92%8Cor%E7%9A%84%E6%95%88%E7%8E%87/" class="post-title-link" itemprop="url">浅尝in和or的效率</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-07-10 12:35:53 / 修改时间：13:26:11" itemprop="dateCreated datePublished" datetime="2022-07-10T12:35:53+08:00">2022-07-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="浅尝一下in-和-or-的效率"><a href="#浅尝一下in-和-or-的效率" class="headerlink" title="浅尝一下in 和 or 的效率"></a>浅尝一下in 和 or 的效率</h1><p>数据来源于：<a target="_blank" rel="noopener" href="https://github.com/datacharmer/test_db">https://github.com/datacharmer/test_db</a></p>
<h2 id="首先看一下语句"><a href="#首先看一下语句" class="headerlink" title="首先看一下语句"></a>首先看一下语句</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- in 语句</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> first_name <span class="keyword">in</span> (<span class="string">&#x27;Georgi&#x27;</span>,<span class="string">&#x27;Bezalel&#x27;</span>,<span class="string">&#x27;Parto&#x27;</span>,<span class="string">&#x27;Chirstian&#x27;</span>,<span class="string">&#x27;Kyoichi&#x27;</span>,<span class="string">&#x27;Anneke&#x27;</span>,<span class="string">&#x27;Tzvetan&#x27;</span>,<span class="string">&#x27;Saniya&#x27;</span>,<span class="string">&#x27;Sumant&#x27;</span>,<span class="string">&#x27;Duangkaew&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- or 语句</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> employees <span class="keyword">where</span> </span><br><span class="line">	first_name <span class="operator">=</span> <span class="string">&#x27;Georgi&#x27;</span> <span class="keyword">OR</span></span><br><span class="line">	first_name <span class="operator">=</span> <span class="string">&#x27;Bezalel&#x27;</span> <span class="keyword">OR</span></span><br><span class="line">	first_name <span class="operator">=</span> <span class="string">&#x27;Parto&#x27;</span> <span class="keyword">OR</span></span><br><span class="line">	first_name <span class="operator">=</span> <span class="string">&#x27;Chirstian&#x27;</span> <span class="keyword">OR</span></span><br><span class="line">	first_name <span class="operator">=</span> <span class="string">&#x27;Kyoichi&#x27;</span> <span class="keyword">OR</span></span><br><span class="line">	first_name <span class="operator">=</span> <span class="string">&#x27;Anneke&#x27;</span> <span class="keyword">OR</span></span><br><span class="line">	first_name <span class="operator">=</span> <span class="string">&#x27;Tzvetan&#x27;</span> <span class="keyword">OR</span></span><br><span class="line">	first_name <span class="operator">=</span> <span class="string">&#x27;Saniya&#x27;</span> <span class="keyword">OR</span></span><br><span class="line">	first_name <span class="operator">=</span> <span class="string">&#x27;Sumant&#x27;</span> <span class="keyword">OR</span></span><br><span class="line">	first_name <span class="operator">=</span> <span class="string">&#x27;Duangkaew&#x27;</span> ;</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<h2 id="运行截图"><a href="#运行截图" class="headerlink" title="运行截图"></a>运行截图</h2><ul>
<li>in的效率</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Ran968777/images/imgs/image-20220425110540235.png" alt="image-20220425110540235"></p>
<ul>
<li><p>or的效率</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ran968777/images/imgs/image-20220425110637534.png" alt="image-20220425110637534"></p>
</li>
</ul>
<p>因为上面语句的检索范围只有10个，所以效率的体现还不是非常明显。但是当参数集合范围增大，IN的性能却不会太大下降，而OR会下降非常厉害。这是为什么呢？大概的检索原理是：</p>
<ul>
<li><p>OR，是从查询条件的参数集合里一个一个的去匹配，直到匹配成功或者一个都匹配不上，时间复杂度O(n)</p>
</li>
<li><p>IN，通过二叉树查找，时间复杂度O(log n)</p>
</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/71064147">https://zhuanlan.zhihu.com/p/71064147</a></p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#operator_in">https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#operator_in</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ran</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ran</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
